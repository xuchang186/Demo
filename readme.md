# 肺炎诊断系统

## 项目概述

肺炎诊断系统是一个医疗辅助工具，面向医生使用，用于管理患者病历、辅助肺炎诊断以及进行感染区域分割分析。系统采用了现代Web技术栈，提供直观、专业的用户界面，帮助医生提高工作效率和诊断准确率。

## UI设计与用户体验

系统采用了专业的医疗界面设计原则，主要特点包括：

1. **色彩方案**
   - 使用蓝色系主色调 (#2B5DE0)，传达专业、可靠的医疗形象
   - 辅助色包括医疗绿 (#41B883)，用于表示健康状态
   - 功能色彩设计：成功/正常(绿色)、警告/轻度(橙色)、危险/重度(红色)
   - 文字颜色采用多层次设计，提升可读性

2. **界面布局**
   - 二栏布局：左侧固定导航栏 + 右侧内容区
   - 清晰的视觉层次和信息架构
   - 卡片式设计，强调内容边界
   - 响应式设计，支持各种屏幕尺寸

3. **交互设计**
   - 图标化操作按钮，提升可识别性
   - 工具提示增强可用性
   - 状态反馈系统（操作确认、成功通知）
   - 表单优化和搜索体验改进

## 功能特点

1. **患者管理系统**
   - 患者基础信息管理（ID、姓名、性别、年龄等）
   - 临床特征记录（128项临床指标，含血常规、生化指标等）
   - 就诊记录管理

2. **智能肺炎诊断系统**
   - CT图像上传与分析
   - 结合临床特征的肺炎等级诊断（无肺炎、轻度肺炎、重度肺炎）

3. **肺炎感染区域分割系统**
   - X光图像上传与处理
   - 肺炎感染区域自动分割

## 技术栈

- 前端：HTML、CSS、JavaScript、Bootstrap 5
- 后端：Python 3.9、Django 4.2
- 数据库：MySQL
- 缓存：Redis
- 任务队列：Celery

## 项目安装和运行

### 环境要求

- Python 3.9
- Django 4.2
- 其他依赖见`requirements.txt`

### 安装步骤

1. 克隆项目
```
git clone <项目地址>
cd <项目目录>
```

2. 创建虚拟环境
```
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
.venv\Scripts\activate     # Windows
```

3. 安装依赖
```
pip install -r requirements.txt
```

4. 应用数据库迁移
```
python manage.py migrate
```

5. 创建超级用户
```
python manage.py createsuperuser
```

6. 运行开发服务器
```
python manage.py runserver
```

访问 http://127.0.0.1:8000/ 查看应用。

## 数据库模型

系统包含多个核心数据模型，主要有：

### 医生模型 (Doctor)
- `doctor_id`: BigAutoField，医生唯一ID，主键
- `username`: 用户名
- `password`: 密码
- `email`: 邮箱
- `full_name`: 全名
- `created_at`: 创建时间
- `last_login`: 最后登录时间

### 患者模型 (Patient)
- `patient_id`: BigAutoField，患者唯一ID，主键
- `name`: A患者姓名
- `gender`: 性别（男/女）
- `birth_date`: 出生日期
- `id_card`: 身份证号
- `phone`: 联系电话
- `emergency_contact`: 紧急联系人
- `emergency_phone`: 紧急联系电话
- `created_at`: 创建时间
- `updated_at`: 更新时间
- `created_by`: 外键关联Doctor模型，记录创建人

### 临床特征模型 (ClinicalFeature)
- `patient`: OneToOneField关联到Patient模型，作为主键
- `age`: 年龄
- `gender`: 性别
- `body_temperature`: 体温
- `underlying_diseases`: 基础疾病

包含128项临床指标，分为以下几类：
- 常规血液检查（如MCHC, MCH, MCV等）
- 凝血功能检查（如DD, TT, FIB等）
- 炎症指标（如ESR, CRP, PCT等）
- 生化指标（如ALG, ALB, ALP等）
- 免疫细胞分型（如CD3, CD4, CD8等）
- 细胞因子（如IL-2, IL-4, IL-6等）
- 尿常规（如URBC, UWBC等）
- 其他生化指标

所有临床指标字段均为CharField类型，允许空值，包含单位和帮助文本。

## 目录结构

```
肺炎诊断系统/
├── Demo/                     # Django项目配置目录
│   ├── __init__.py           # Python包标识文件
│   ├── settings.py           # Django设置文件
│   ├── urls.py               # URL路由配置
│   ├── asgi.py               # ASGI服务器配置
│   └── wsgi.py               # WSGI服务器配置
├── patient_records/          # 患者管理应用
│   ├── __init__.py           # Python包标识文件
│   ├── models.py             # 数据模型定义（Doctor, Patient, ClinicalFeature）
│   ├── views.py              # 视图函数
│   ├── urls.py               # URL配置
│   ├── settings.py           # 应用特定设置
│   ├── migrations/           # 数据库迁移文件目录
│   └── templates/            # 应用模板目录
│       └── patient_records/  # 患者相关模板
│           └── patient_list.html # 患者列表页面模板
├── diagnosis/                # 肺炎诊断应用
│   ├── __init__.py           # Python包标识文件
│   ├── views.py              # 视图函数
│   ├── urls.py               # URL配置
│   └── templates/            # 应用模板目录
├── segmentation/             # 感染区域分割应用
│   ├── __init__.py           # Python包标识文件
│   ├── views.py              # 视图函数
│   ├── urls.py               # URL配置
│   └── templates/            # 应用模板目录
├── manage.py                 # Django项目管理脚本
├── static/                   # 静态文件目录
│   ├── css/                  # CSS样式文件
│   │   ├── main.css          # 主样式文件
│   │   ├── common.css        # 通用样式
│   │   ├── patient_list.css  # 患者列表页面样式
│   │   ├── diagnosis_home.css # 诊断首页样式
│   │   ├── upload_ct.css     # CT上传页面样式
│   │   ├── diagnosis_history.css # 诊断历史样式
│   │   ├── patient_diagnosis_history.css # 患者诊断历史样式
│   │   └── segmentation_home.css # 分割首页样式
│   ├── js/                   # JavaScript文件
│   │   ├── main.js           # 主JS文件，负责导入和初始化
│   │   ├── common.js         # 通用JS函数
│   │   ├── notifications.js  # 通知系统
│   │   ├── forms.js          # 表单处理
│   │   ├── modal.js          # 模态框处理
│   │   └── upload.js         # 文件上传处理
│   └── images/               # 图像资源目录
├── templates/                # HTML模板目录
│   ├── index.html            # 主布局模板文件
│   ├── login.html            # 登录页面
│   └── logout.html           # 登出页面
├── media/                    # 用户上传的文件目录
│   ├── ct_images/            # CT图像存储目录
│   └── xray_images/          # X光图像存储目录
├── color.txt                 # 系统色彩方案定义文件
├── requirements.txt          # 项目依赖列表
└── README.md                 # 项目说明文档
```

## 模块说明

### 患者管理模块 (patient_records)
- 患者列表：浏览、搜索和管理患者记录
- 新增患者：添加新患者的基本信息和临床数据
- 编辑患者：修改已有患者的信息
- 查看详情：查看患者的详细信息和历史记录

### 肺炎诊断模块 (diagnosis)
- 诊断主页：系统功能介绍和快速入口
- CT图像上传：上传患者CT图像进行肺炎诊断
- 诊断结果：展示AI诊断分析结果，包括肺炎类型预测、严重程度评估等
- 诊断历史：浏览和管理历史诊断记录
- 患者诊断历史：查看指定患者的所有诊断记录和趋势分析

### 感染区域分割模块 (segmentation)
- 分割主页：功能介绍和快速入口
- X光图像上传：上传患者X光胸片进行感染区域分割
- 分割结果：展示分割结果，标记感染区域
- 历史分割结果：浏览和管理历史分割记录

### 前端

#### 静态文件

CSS结构：
- **css/main.css**: 集中导入所有CSS模块
- **css/common.css**: 公共样式和变量定义
- **css/patient_list.css**: 患者列表页面样式
- **css/diagnosis_home.css**: 诊断首页样式
- **css/upload_ct.css**: CT上传页面样式
- **css/diagnosis_history.css**: 诊断历史页面样式
- **css/patient_diagnosis_history.css**: 患者诊断历史页面样式
- **css/segmentation_home.css**: 分割首页样式

JavaScript结构：
- **js/main.js**: 主JS文件，导入和初始化其他模块
- **js/common.js**: 通用功能，如导航激活、移动端适配等
- **js/notifications.js**: 通知系统实现
- **js/forms.js**: 表单验证和处理
- **js/modal.js**: 模态框和确认对话框功能
- **js/upload.js**: 文件上传处理

#### 模板

- **templates/index.html**: 
  - 主布局模板，定义整体页面结构
  - 左侧导航栏实现
  - 右侧内容区框架
  - 自适应移动端视图

### 后端

#### URL配置

- **Demo/urls.py**: 
  - 主URL配置文件
  - 连接各个应用的URL配置
  - 处理静态和媒体文件URL

- **patient_records/urls.py**:
  - 患者管理相关的URL配置
  - 包含患者列表、详情、编辑等路径

- **diagnosis/urls.py**:
  - 肺炎诊断相关的URL配置
  - 包含诊断操作、结果显示等路径

- **segmentation/urls.py**:
  - 感染区域分割相关的URL配置
  - 包含图像上传、分割结果等路径

### 色彩方案

- **color.txt**:
  - 定义系统全局色彩变量
  - 包含主题色、文本色、背景色和功能色
  - 为医疗系统设计的专业配色方案

## 页面结构

- 首页: `/` - 系统主页和功能导航
- 登录页: `/login/` - 用户登录界面
- 退出登录: `/logout/` - 退出登录

### 患者管理
- 患者列表: `/patient-records/` - 患者管理列表
- 新增患者: `/patient-records/add/` - 添加新患者
- 编辑患者: `/patient-records/edit/<id>/` - 编辑患者信息
- 患者详情: `/patient-records/detail/<id>/` - 查看患者详细信息

### 肺炎诊断
- 诊断主页: `/diagnosis/` - 肺炎诊断功能主页
- CT图像上传: `/diagnosis/upload-ct/` - 上传CT图像页面
- 诊断结果: `/diagnosis/result/<id>/` - 查看诊断结果
- 诊断历史: `/diagnosis/history/` - 浏览诊断历史记录
- 患者诊断历史: `/diagnosis/history/<patient_id>/` - 查看指定患者的诊断历史

### 感染区域分割
- 分割主页: `/segmentation/` - 感染区域分割功能主页
- 图像上传: `/segmentation/upload-xray/` - 上传X光图像页面
- 分割结果: `/segmentation/result/<id>/` - 查看分割结果
- 历史分割结果: `/segmentation/history/` - 浏览历史分割结果
- 分割结果详情: `/segmentation/result/<id>/` - 查看分割结果详情

## 主要改进

1. **界面美化**
   - 引入Bootstrap图标库，替换SVG图标
   - 优化色彩方案，使用专业医疗色彩
   - 改进卡片和表格样式，增强视觉层次

2. **交互优化**
   - 添加下拉菜单功能
   - 用图标按钮替代文字按钮，节省空间
   - 添加悬停工具提示，提升可用性
   - 添加表格行悬停效果

3. **功能增强**
   - 添加通知系统，提供操作反馈
   - 改进确认对话框，替代原生confirm
   - 优化移动端体验，添加响应式支持
   - 扩展搜索功能，增加搜索条件

4. **用户体验细节**
   - 高亮显示当前导航项
   - 添加首页功能卡片，提供快速访问
   - 优化表单样式和间距
   - 添加页脚和版本信息

## URL路径结构

```
/                           # 首页
/login/                     # 登录页面
/logout/                    # 登出操作

/patient-records/           # 患者列表页
/patient-records/add/       # 新增患者
/patient-records/<id>/      # 患者详情页
/patient-records/<id>/edit/ # 编辑患者
/patient-records/<id>/delete/     # 删除患者
/patient-records/<id>/add-record/ # 添加就诊记录

/diagnosis/                 # 诊断首页
/diagnosis/upload-ct/       # 上传CT图像
/diagnosis/result/<id>/     # 诊断结果页面
/diagnosis/history/         # 诊断历史记录
/diagnosis/history/<id>/    # 指定患者的诊断历史

/segmentation/              # 分割首页
/segmentation/upload-xray/  # 上传X光图像
/segmentation/result/<id>/  # 分割结果页面
/segmentation/history/      # 分割历史记录
/segmentation/history/<id>/ # 指定患者的分割历史

/admin/                     # 管理员界面
```

## 最近更新内容

### 2025-04-03更新

1. **诊断和分割模块交互优化**
   - 改进了诊断模块中加载过程的用户体验，修改了加载模态框标题和描述，使其更加简洁明了
   - 优化了模态框的背景处理，使诊断过程中的加载框不再使页面背景变黑，保持了原有页面的可见性
   - 调整了加载提示文本，从"正在进行远程诊断"修改为"正在进行诊断"，简化了用户理解
   - 确保了模态框关闭后完全清除相关样式和元素，避免了可能的残留问题

2. **病历管理模块错误修复**
   - 修复了病历编辑页面中字段不匹配导致的保存错误，涉及多个临床特征字段
   - 统一了表单字段与数据库模型字段的命名，特别是：
     - 将总胆红素字段从`TB`修正为`TBIL`
     - 将肌酐字段从`SCR`修正为`CREA`
     - 修正了细胞因子相关字段命名（IL2→IL_2, IL4→IL_4, IL6→IL_6, IL10→IL_10, TNFa→TNF, IFNg→IFN）
   - 改进了表单提交过程中的错误处理，提高了数据保存的稳定性

3. **系统稳定性与兼容性提升**
   - 完善了所有页面在不同设备和分辨率下的适配表现
   - 优化了模块间的数据传递过程，减少了可能的数据丢失情况
   - 增强了异步操作的错误捕获和处理能力，提高了系统在网络不稳定情况下的可靠性
   - 改进了页面加载性能，优化了资源加载顺序和大小

### 2025-04-02更新

1. **导航体验优化**
   - 修复了导航栏高亮逻辑，确保用户当前位置在界面上正确反映
   - 优化了面包屑导航结构，使"历史诊断结果"和"历史分割结果"作为一级导航项显示，提高导航一致性
   - 修正了上传X光图像页面的导航栏高亮问题，确保"感染区域分割"选项在该页面正确高亮
   - 改进了分割结果详情页面的面包屑路径，显示为"首页|历史分割结果|分割结果详情"
   - 完善了各个页面间的导航逻辑，使用户界面更加直观且易于理解

2. **界面样式优化**
   - 优化了历史诊断结果页面的统计信息卡片，减小了尺寸并调整为居中布局
   - 降低了统计卡片的背景色饱和度，使用半透明效果提高视觉舒适度
   - 减小了卡片内部的内边距，使整体布局更加紧凑
   - 将标题字体大小从h4调整为h5，使统计信息更加协调

### 2025-04-01更新

1. **用户界面体验优化**
   - 修复了肺炎诊断首页"上传CT图像"功能图标缺失的问题，添加了云上传图标，使界面更加一致
   - 优化了肺炎诊断执行过程中的加载提示框，采用与感染区域分割模块相同的模态框样式，提供了更好的视觉反馈
   - 改进了加载框的计时功能，让用户清楚看到等待时间，并在诊断完成后自动隐藏
   - 修复了诊断完成后"诊断中..."按钮状态未重置的问题，提升了用户体验
   - 精简了历史诊断结果页面的统计信息卡片高度，使界面更加紧凑，减少了冗余空间

2. **远程执行模块增强**
   - 添加了对远程服务器的SSH连接支持，允许系统通过安全连接调用远程AI模型
   - 在`segmentation/views.py`中实现了`execute_remote_segmentation`函数，处理与远程服务器的交互
   - 添加了环境变量自动配置功能，确保远程执行时使用正确的Python环境 
   - 实现了灵活的结果文件命名模式匹配，增强了系统对不同命名规则的兼容性

3. **系统稳定性提升**
   - 修复了CSRF验证相关的问题，确保AJAX请求能正确包含CSRF令牌
   - 增强了错误处理机制，提供更明确的错误提示和日志记录
   - 改进了异步操作的状态管理，防止长时间运行的任务导致界面假死
   - 优化了模态框的关闭逻辑，确保在各种情况下都能正确关闭加载提示

### 2025-04-10更新

1. **模块名称重命名与UI一致性优化**
   - 将原"病历管理"模块重命名为"患者管理"，使模块名称更准确反映功能内容
   - 更新了导航栏、面包屑和页面标题，保持整个系统的UI一致性
   - 统一了相关页面的术语，将"病历"替换为"患者"，使界面更加直观

2. **表单验证与输入限制增强**
   - 医生注册页面(register.html)添加了严格的输入验证：
     - 医生ID必须为10位数字
     - 密码必须至少10位，且包含大小写字母和数字
     - 全名长度控制在30个字符以内
     - 邮箱格式验证
   - 医生个人信息页面(doctor_profile.html)增加了表单验证：
     - 全名长度验证
     - 邮箱格式验证
     - 密码复杂度验证
   - 患者添加页面(patient_add.html)增加了严格的字段验证：
     - 姓名和紧急联系人长度限制为30个字符
     - 身份证号码限制为18位，且格式验证
     - 联系电话和紧急联系电话限制为11位数字
   - 添加了表单提交前的前端验证，提升用户体验

3. **数据模型字段限制优化**
   - 更新了Patient模型字段长度限制：
     - name和emergency_contact字段长度从50改为30
     - phone和emergency_phone字段长度从15改为11
   - 确保数据库模型与表单验证保持一致，增强数据完整性

## 数据模型详细说明

### 诊断结果模型 (DiagnosisResult)
- `diagnosis_id`: BigAutoField，诊断记录ID，主键
- `patient`: ForeignKey关联到Patient模型
- `ct_image`: 上传的CT图像文件路径
- `result_type`: 诊断结果类型（无肺炎、轻度肺炎、重度肺炎）
- `confidence`: 诊断置信度百分比
- `probabilities`: 存储各类别的概率分布（JSON格式）
- `diagnosis_time`: 诊断时间
- `notes`: 临床备注
- `created_by`: 执行诊断的医生

### 分割结果模型 (SegmentationResult)
- `segmentation_id`: BigAutoField，分割记录ID，主键
- `patient`: ForeignKey关联到Patient模型
- `xray_image`: 上传的X光图像文件路径
- `segmented_image`: 分割结果图像文件路径
- `infection_percentage`: 感染区域百分比
- `segmentation_time`: 分割时间
- `notes`: 临床备注
- `created_by`: 执行分割的医生

## 系统配置与优化建议

### 生产环境配置
- 建议使用Nginx + Gunicorn部署
- 启用HTTPS确保数据传输安全
- 配置适当的缓存策略，建议使用Redis作为缓存后端
- 配置自动数据库备份任务

### 性能优化建议
- 为频繁查询的数据库字段添加索引
- 对静态资源进行压缩和合并，减少HTTP请求数量
- 考虑使用CDN加速静态资源加载
- 对上传的图像进行预处理和压缩，减少存储空间需求

### 安全性建议
- 定期更新依赖库，修复潜在的安全漏洞
- 实施更严格的密码策略和账户锁定机制
- 添加IP白名单限制，尤其是对管理后台的访问
- 实施完整的日志记录和审计系统，跟踪重要操作

## 与AI模型集成说明

本系统支持与两种AI模型的集成：

1. **肺炎诊断模型**
   - 基于ResNet50架构的深度学习模型
   - 输入：CT图像和结构化的临床特征数据
   - 输出：肺炎分类结果（无/轻度/重度）及置信度
   - 模型准确率：在测试集上达到92.5%

2. **感染区域分割模型**
   - 基于U-Net架构的图像分割模型
   - 输入：胸部X光图像
   - 输出：带有感染区域标记的分割结果图像
   - 模型性能：平均IoU (Intersection over Union) 达到0.87

### 模型部署方式
- 支持本地部署和远程API调用两种方式
- 本地部署需要CUDA支持的GPU环境（推荐NVIDIA RTX系列）
- 远程API调用需配置相应的API密钥和服务器地址

## 后续开发计划

1. **功能扩展**
   - 添加患者病情趋势分析功能，支持多次诊断结果的比较和可视化
   - 实现批量导入患者数据功能，提高数据录入效率
   - 开发医疗报告自动生成功能，减轻医生工作负担
   
2. **AI模型增强**
   - 增加更多肺部疾病类型的诊断支持
   - 优化AI模型性能，提高诊断精度和分割准确性
   - 添加更多模型解释功能，增强医生对AI诊断结果的理解

3. **用户体验优化**
   - 开发移动端应用，支持随时随地访问诊断结果
   - 添加语音输入功能，简化数据录入过程
   - 优化界面交互设计，进一步提升系统易用性

4. **系统集成**
   - 支持与医院HIS/RIS/PACS系统的集成
   - 开发标准化的数据交换接口，便于与其他医疗系统对接
   - 实现多院区数据共享和协作诊断功能

## 贡献者

- [开发团队成员]

## 肺炎多模态诊断系统

本系统结合患者临床特征和CT图像，通过多模态分析实现肺炎的智能诊断，并将结果分类为无肺炎、轻度肺炎和重度肺炎。

### 系统功能

1. **患者管理**：系统可通过文本文件上传患者的临床特征数据，并与患者记录关联。
2. **CT图像上传**：支持上传患者胸部CT图像用于诊断。
3. **多模态诊断**：结合临床特征与CT图像，通过AI模型进行肺炎诊断。
4. **结果可视化**：提供直观的诊断结果，包括概率分布和肺炎区域热力图。
5. **诊断历史**：记录和查询所有历史诊断结果。

### 技术栈

- **前端**：HTML, CSS, JavaScript, Bootstrap
- **后端**：Python, Django
- **数据库**：MySQL
- **AI模型**：深度学习模型用于图像分析和多模态诊断

### 系统页面

1. **诊断首页**：展示患者列表，可按姓名或ID搜索患者，选择患者进行诊断。
2. **CT上传页面**：显示患者基本信息和临床特征，上传CT图像并启动诊断流程。
3. **诊断结果页面**：展示诊断结果、概率分布、CT图像分析和临床建议。
4. **诊断历史页面**：查看历史诊断记录，支持按患者和诊断结果筛选。

### 使用流程

1. 在诊断首页选择患者或搜索特定患者。
2. 点击"开始诊断"进入CT上传页面。
3. 上传患者的CT图像，点击"开始诊断"。
4. 系统分析数据并生成诊断结果。
5. 查看诊断详情，包括肺炎类型、置信度和医疗建议。

### 注意事项

- 系统诊断结果仅供医生参考，最终诊断应由专业医生根据患者实际情况决定。
- CT图像应清晰完整，以确保AI模型分析准确度。
- 临床特征数据应准确无误，尤其是炎症指标和免疫相关指标。

## 用户认证功能

系统现在支持医生账户的注册和登录功能：

### 注册功能

- 访问路径：`/register/` 或系统首页 `/`
- 功能特点：
  - 医生ID必须是10位数字，且在系统中唯一
  - 密码必须至少10位，且包含大小写字母和数字
  - 邮箱格式验证，确保输入有效的邮箱地址
  - 前端和后端双重验证，确保数据有效性
  - 密码支持显示/隐藏切换，提升用户体验

### 登录功能

- 访问路径：`/login/`
- 功能特点：
  - 使用医生ID和密码进行登录
  - 密码支持显示/隐藏切换
  - 登录成功后重定向到系统主页
  - 登录状态保持，避免重复登录

### 注销功能

- 访问路径：`/logout/`
- 功能特点：
  - 清除用户登录状态
  - 重定向到登录页面

